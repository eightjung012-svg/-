#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// 문자열 파싱 함수
void get_json_string(char *json, char *key, char *output) {
    char search_key[100];
    sprintf(search_key, "\"%s\":\"", key); 
    char *start = strstr(json, search_key);
    if (start) {
        start += strlen(search_key);
        char *end = strchr(start, '\"');
        if (end) {
            int length = end - start;
            strncpy(output, start, length);
            output[length] = '\0';
        } else { strcpy(output, ""); }
    } else { strcpy(output, ""); }
}

// 실수(인기도) 파싱 함수
double get_json_double(char *json, char *key) {
    char search_key[100];
    sprintf(search_key, "\"%s\":", key);
    char *start = strstr(json, search_key);
    if (start) {
        start += strlen(search_key);
        return atof(start);
    }
    return 0.0;
}

int main() {
    // -------------------------------------------------------
    // 1. 어제 날짜 데이터 준비
    // -------------------------------------------------------
    time_t t = time(NULL);
    t -= 86400; // 하루 전(어제)
    struct tm tm = *localtime(&t);

    int month = tm.tm_mon + 1;
    int day = tm.tm_mday;
    int year = tm.tm_year + 1900;

    char date_str[50];
    sprintf(date_str, "%02d_%02d_%d", month, day, year);

    char gz_filename[100];
    sprintf(gz_filename, "movie_ids_%s.json.gz", date_str);
    char json_filename[100];
    sprintf(json_filename, "movie_ids_%s.json", date_str);
    char url[256];
    sprintf(url, "http://files.tmdb.org/p/exports/%s", gz_filename);

    printf("=============================================\n");
    printf("[1단계] 데이터 다운로드 (%s)...\n", date_str);
    
    char command[1024];
    sprintf(command, "curl -f -L -o %s %s", gz_filename, url);
    if (system(command) != 0) return 1;

    printf("[2단계] 압축 해제...\n");
    sprintf(command, "powershell -Command \"$in=[System.IO.File]::OpenRead('%s'); $out=[System.IO.File]::Create('%s'); $gz=[System.IO.Compression.GZipStream]::new($in,[System.IO.Compression.CompressionMode]::Decompress); $gz.CopyTo($out); $gz.Close(); $out.Close(); $in.Close()\"", gz_filename, json_filename);
    system(command);

    // -------------------------------------------------------
    // 2. HTML 파일 만들기
    // -------------------------------------------------------
    printf("[3단계] 웹사이트 생성 중...\n");
    
    FILE *fp_in = fopen(json_filename, "r");
    FILE *fp_out = fopen("index.html", "w");

    if (fp_in == NULL || fp_out == NULL) return 1;

    // HTML 헤더 & CSS (메타크리틱 스타일)
    fprintf(fp_out, "<!DOCTYPE html>\n<html>\n<head>\n");
    fprintf(fp_out, "<meta charset='UTF-8'>\n");
    fprintf(fp_out, "<title>영화 평점 사이트</title>\n");
    fprintf(fp_out, "<style>\n");
    fprintf(fp_out, "  body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f2f2f2; margin: 0; padding: 20px; }\n");
    fprintf(fp_out, "  h1 { text-align: center; color: #333; margin-bottom: 30px; }\n");
    fprintf(fp_out, "  .container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }\n");
    fprintf(fp_out, "  .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s; cursor: pointer; }\n");
    fprintf(fp_out, "  .card:hover { transform: translateY(-5px); box-shadow: 0 8px 12px rgba(0,0,0,0.2); }\n");
    fprintf(fp_out, "  .card-header { height: 120px; background-color: #2c3e50; display: flex; align-items: center; justify-content: center; color: #ecf0f1; font-size: 40px; }\n");
    fprintf(fp_out, "  .card-body { padding: 15px; position: relative; }\n");
    fprintf(fp_out, "  .score-badge { width: 40px; height: 40px; border-radius: 4px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; position: absolute; top: -20px; right: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 14px; }\n");
    fprintf(fp_out, "  .green { background-color: #66cc33; }\n");
    fprintf(fp_out, "  .yellow { background-color: #ffcc33; }\n");
    fprintf(fp_out, "  .red { background-color: #ff0000; }\n");
    fprintf(fp_out, "  .title { font-size: 16px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; line-height: 1.4; color: #2c3e50; }\n");
    fprintf(fp_out, "  .id-text { font-size: 12px; color: #95a5a6; }\n");
    fprintf(fp_out, "  /* 링크 스타일 제거 */ a { text-decoration: none; color: inherit; }\n");
    fprintf(fp_out, "</style>\n</head>\n<body>\n");
    
    fprintf(fp_out, "<h1>?? 일일 영화 인기도 순위 (%d-%02d-%02d)</h1>\n", year, month, day);
    fprintf(fp_out, "<div class='container'>\n");

    char buffer[4096];
    char title[1024];
    double popularity;
    int id;
    int count = 0;

    while (fgets(buffer, sizeof(buffer), fp_in) != NULL) {
        get_json_string(buffer, "original_title", title);
        popularity = get_json_double(buffer, "popularity");
        id = (int)get_json_double(buffer, "id");

        if (strlen(title) > 0) {
            char *color_class = "red";
            if (popularity >= 10.0) color_class = "green";
            else if (popularity >= 5.0) color_class = "yellow";

            // 클릭하면 TMDB 실제 페이지로 이동하도록 링크 추가
            fprintf(fp_out, "  <a href='https://www.themoviedb.org/movie/%d' target='_blank'>\n", id);
            fprintf(fp_out, "  <div class='card'>\n");
            fprintf(fp_out, "    <div class='card-header'>??</div>\n");
            fprintf(fp_out, "    <div class='card-body'>\n");
            fprintf(fp_out, "      <div class='score-badge %s'>%.1f</div>\n", color_class, popularity);
            fprintf(fp_out, "      <div class='title'>%s</div>\n", title);
            fprintf(fp_out, "      <div class='id-text'>ID: %d</div>\n", id);
            fprintf(fp_out, "    </div>\n");
            fprintf(fp_out, "  </div>\n");
            fprintf(fp_out, "  </a>\n");

            count++;
        }
        if (count >= 100) break; // 100개만 출력
    }

    fprintf(fp_out, "</div>\n</body>\n</html>");

    fclose(fp_in);
    fclose(fp_out);
    
    // 파일 정리
    sprintf(command, "del %s", gz_filename);
    system(command);
    sprintf(command, "del %s", json_filename);
    system(command);

    printf("완료! 브라우저를 실행합니다...\n");

    // [핵심] 브라우저 자동 실행 명령어
    system("start index.html");

    return 0;
}
