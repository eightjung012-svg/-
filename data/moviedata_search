#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜ (0: ì—†ìŒ, 1: ìˆìŒ)
int file_exists(const char *filename) {
    FILE *file = fopen(filename, "r");
    if (file) {
        fclose(file);
        return 1;
    }
    return 0;
}

// ë¬¸ìì—´ íŒŒì‹± í•¨ìˆ˜
void get_json_string(char *json, char *key, char *output) {
    char search_key[100];
    sprintf(search_key, "\"%s\":\"", key); 
    char *start = strstr(json, search_key);
    if (start) {
        start += strlen(search_key);
        char *end = strchr(start, '\"');
        if (end) {
            int length = end - start;
            strncpy(output, start, length);
            output[length] = '\0';
        } else { strcpy(output, ""); }
    } else { strcpy(output, ""); }
}

// ì‹¤ìˆ˜(ì¸ê¸°ë„) íŒŒì‹± í•¨ìˆ˜
double get_json_double(char *json, char *key) {
    char search_key[100];
    sprintf(search_key, "\"%s\":", key);
    char *start = strstr(json, search_key);
    if (start) {
        start += strlen(search_key);
        return atof(start);
    }
    return 0.0;
}

int main() {
    // -------------------------------------------------------
    // 1. ì–´ì œ ë‚ ì§œ ê³„ì‚°
    // -------------------------------------------------------
    time_t t = time(NULL);
    t -= 86400; // ì–´ì œ
    struct tm tm = *localtime(&t);

    int month = tm.tm_mon + 1;
    int day = tm.tm_mday;
    int year = tm.tm_year + 1900;

    char date_str[50];
    sprintf(date_str, "%02d_%02d_%d", month, day, year);

    char gz_filename[100];
    sprintf(gz_filename, "movie_ids_%s.json.gz", date_str);
    char json_filename[100];
    sprintf(json_filename, "movie_ids_%s.json", date_str);
    char url[256];
    sprintf(url, "http://files.tmdb.org/p/exports/%s", gz_filename);

    printf("=============================================\n");
    printf("íƒ€ê²Ÿ ë‚ ì§œ: %s\n", date_str);

    // -------------------------------------------------------
    // [í•µì‹¬ ê¸°ëŠ¥] íŒŒì¼ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸!
    // -------------------------------------------------------
    if (file_exists(json_filename)) {
        printf("âœ… [í™•ì¸] ì´ë¯¸ ë‹¤ìš´ë¡œë“œ ë°›ì€ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤!\n");
        printf(">>> ë‹¤ìš´ë¡œë“œ ë° ì••ì¶• í•´ì œ ë‹¨ê³„ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.\n");
    } 
    else {
        // íŒŒì¼ì´ ì—†ìœ¼ë©´ ë‹¤ìš´ë¡œë“œ ìˆ˜í–‰
        printf("âŒ [í™•ì¸] íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.\n");
        
        printf("[1ë‹¨ê³„] ë°ì´í„° ë‹¤ìš´ë¡œë“œ...\n");
        char command[1024];
        sprintf(command, "curl -f -L -o %s %s", gz_filename, url);
        if (system(command) != 0) {
            printf("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì¸í„°ë„· ì—°ê²° í™•ì¸).\n");
            return 1;
        }

        printf("[2ë‹¨ê³„] ì••ì¶• í•´ì œ...\n");
        sprintf(command, "powershell -Command \"$in=[System.IO.File]::OpenRead('%s'); $out=[System.IO.File]::Create('%s'); $gz=[System.IO.Compression.GZipStream]::new($in,[System.IO.Compression.CompressionMode]::Decompress); $gz.CopyTo($out); $gz.Close(); $out.Close(); $in.Close()\"", gz_filename, json_filename);
        system(command);
        
        // ì••ì¶• íŒŒì¼(.gz)ì€ ì´ì œ í•„ìš” ì—†ìœ¼ë‹ˆ ì‚­ì œ
        sprintf(command, "del %s", gz_filename);
        system(command);
    }

    // -------------------------------------------------------
    // 3. HTML ìƒì„± (íŒŒì¼ì´ ìˆë“  ì—†ë“  í•­ìƒ ìˆ˜í–‰í•˜ì—¬ ìµœì‹ í™”)
    // -------------------------------------------------------
    printf("[3ë‹¨ê³„] ì›¹ì‚¬ì´íŠ¸ ìƒì„± ì¤‘ (index.html)...\n");
    
    FILE *fp_in = fopen(json_filename, "r");
    FILE *fp_out = fopen("index.html", "w");

    if (fp_in == NULL) {
        printf("ì˜¤ë¥˜: ë°ì´í„° íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n");
        return 1;
    }

    // HTML í—¤ë” ì‘ì„±
    fprintf(fp_out, "<!DOCTYPE html>\n<html>\n<head>\n");
    fprintf(fp_out, "<meta charset='UTF-8'>\n");
    fprintf(fp_out, "<title>ì˜í™” í‰ì  ì‚¬ì´íŠ¸</title>\n");
    fprintf(fp_out, "<style>\n");
    fprintf(fp_out, "  body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f2f2f2; margin: 0; padding: 20px; }\n");
    fprintf(fp_out, "  h1 { text-align: center; color: #333; margin-bottom: 30px; }\n");
    fprintf(fp_out, "  .info-text { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }\n");
    fprintf(fp_out, "  .container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }\n");
    fprintf(fp_out, "  .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s; cursor: pointer; }\n");
    fprintf(fp_out, "  .card:hover { transform: translateY(-5px); box-shadow: 0 8px 12px rgba(0,0,0,0.2); }\n");
    fprintf(fp_out, "  .card-header { height: 120px; background-color: #2c3e50; display: flex; align-items: center; justify-content: center; color: #ecf0f1; font-size: 40px; }\n");
    fprintf(fp_out, "  .card-body { padding: 15px; position: relative; }\n");
    fprintf(fp_out, "  .score-badge { width: 40px; height: 40px; border-radius: 4px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; position: absolute; top: -20px; right: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 14px; }\n");
    fprintf(fp_out, "  .green { background-color: #66cc33; }\n");
    fprintf(fp_out, "  .yellow { background-color: #ffcc33; }\n");
    fprintf(fp_out, "  .red { background-color: #ff0000; }\n");
    fprintf(fp_out, "  .title { font-size: 16px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; line-height: 1.4; color: #2c3e50; }\n");
    fprintf(fp_out, "  .id-text { font-size: 12px; color: #95a5a6; }\n");
    fprintf(fp_out, "  a { text-decoration: none; color: inherit; }\n");
    fprintf(fp_out, "</style>\n</head>\n<body>\n");
    
    fprintf(fp_out, "<h1>ğŸ¬ ì¼ì¼ ì˜í™” ìˆœìœ„ (%s)</h1>\n", date_str);
    fprintf(fp_out, "<div class='info-text'>ë°ì´í„° ì¶œì²˜: TMDB Daily Export (Local Cache)</div>\n");
    fprintf(fp_out, "<div class='container'>\n");

    char buffer[4096];
    char title[1024];
    double popularity;
    int id;
    int count = 0;

    // ë°ì´í„° ì½ê¸°
    while (fgets(buffer, sizeof(buffer), fp_in) != NULL) {
        get_json_string(buffer, "original_title", title);
        popularity = get_json_double(buffer, "popularity");
        id = (int)get_json_double(buffer, "id");

        if (strlen(title) > 0) {
            char *color_class = "red";
            if (popularity >= 10.0) color_class = "green";
            else if (popularity >= 5.0) color_class = "yellow";

            fprintf(fp_out, "  <a href='https://www.themoviedb.org/movie/%d' target='_blank'>\n", id);
            fprintf(fp_out, "  <div class='card'>\n");
            fprintf(fp_out, "    <div class='card-header'>ğŸ¿</div>\n");
            fprintf(fp_out, "    <div class='card-body'>\n");
            fprintf(fp_out, "      <div class='score-badge %s'>%.1f</div>\n", color_class, popularity);
            fprintf(fp_out, "      <div class='title'>%s</div>\n", title);
            fprintf(fp_out, "      <div class='id-text'>ID: %d</div>\n", id);
            fprintf(fp_out, "    </div>\n");
            fprintf(fp_out, "  </div>\n");
            fprintf(fp_out, "  </a>\n");

            count++;
        }
        if (count >= 100) break; // 100ê°œë§Œ ì¶œë ¥
    }

    fprintf(fp_out, "</div>\n</body>\n</html>");

    fclose(fp_in);
    fclose(fp_out);

    // [ì¤‘ìš”] ì´ë²ˆì—ëŠ” json íŒŒì¼ì„ ì‚­ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤! (ë‹¤ìŒ ì‹¤í–‰ ë•Œ ì¬ì‚¬ìš© ìœ„í•´)
    // .gz íŒŒì¼ì€ ìœ„ì—ì„œ ì´ë¯¸ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.

    printf("ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤...\n");
    system("start index.html");

    return 0;
}
