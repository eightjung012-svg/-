#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define MAX_MOVIES 30000 // ë°ì´í„°ë¥¼ ì½ì–´ì˜¬ ìµœëŒ€ ì˜í™” ê°œìˆ˜ (ë©”ëª¨ë¦¬ í™•ë³´ìš©)

// ì˜í™” ì •ë³´ë¥¼ ì €ì¥í•  êµ¬ì¡°ì²´ ì •ì˜
typedef struct {
    int id;
    char title[1024];
    double popularity;
} Movie;

// íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
int file_exists(const char *filename) {
    FILE *file = fopen(filename, "r");
    if (file) {
        fclose(file);
        return 1;
    }
    return 0;
}

// ë¬¸ìì—´ íŒŒì‹± í•¨ìˆ˜
void get_json_string(char *json, char *key, char *output) {
    char search_key[100];
    sprintf(search_key, "\"%s\":\"", key); 
    char *start = strstr(json, search_key);
    if (start) {
        start += strlen(search_key);
        char *end = strchr(start, '\"');
        if (end) {
            int length = end - start;
            strncpy(output, start, length);
            output[length] = '\0';
        } else { strcpy(output, ""); }
    } else { strcpy(output, ""); }
}

// ì‹¤ìˆ˜(ì¸ê¸°ë„) íŒŒì‹± í•¨ìˆ˜
double get_json_double(char *json, char *key) {
    char search_key[100];
    sprintf(search_key, "\"%s\":", key);
    char *start = strstr(json, search_key);
    if (start) {
        start += strlen(search_key);
        return atof(start);
    }
    return 0.0;
}

// ë¬¸ìì—´ ë‚´ ë”°ì˜´í‘œ ì²˜ë¦¬ í•¨ìˆ˜
void escape_quotes(char *dest, const char *src) {
    int i = 0, j = 0;
    while (src[i] != '\0') {
        if (src[i] == '\'') { 
            dest[j++] = '&'; dest[j++] = '#'; dest[j++] = '3'; dest[j++] = '9'; dest[j++] = ';';
        } else if (src[i] == '\"') { 
            dest[j++] = '&'; dest[j++] = 'q'; dest[j++] = 'u'; dest[j++] = 'o'; dest[j++] = 't'; dest[j++] = ';';
        } else {
            dest[j++] = src[i];
        }
        i++;
    }
    dest[j] = '\0';
}

// [í•µì‹¬] qsortë¥¼ ìœ„í•œ ë¹„êµ í•¨ìˆ˜ (ì¸ê¸°ë„ ë‚´ë¦¼ì°¨ìˆœ: ë†’ì€ê²Œ ìœ„ë¡œ)
int compare_movies(const void *a, const void *b) {
    Movie *mA = (Movie *)a;
    Movie *mB = (Movie *)b;
    
    if (mB->popularity > mA->popularity) return 1;  // Bê°€ ë” í¬ë©´ Aë³´ë‹¤ ì•ìœ¼ë¡œ (ë‚´ë¦¼ì°¨ìˆœ)
    if (mB->popularity < mA->popularity) return -1;
    return 0;
}

int main() {
    // 1. ë‚ ì§œ ê³„ì‚°
    time_t t = time(NULL);
    t -= 86400; // ì–´ì œ
    struct tm tm = *localtime(&t);
    int month = tm.tm_mon + 1;
    int day = tm.tm_mday;
    int year = tm.tm_year + 1900;
    char date_str[50];
    sprintf(date_str, "%02d_%02d_%d", month, day, year);

    char gz_filename[100];
    sprintf(gz_filename, "movie_ids_%s.json.gz", date_str);
    char json_filename[100];
    sprintf(json_filename, "movie_ids_%s.json", date_str);
    char url[256];
    sprintf(url, "http://files.tmdb.org/p/exports/%s", gz_filename);

    printf("=============================================\n");
    printf("íƒ€ê²Ÿ ë‚ ì§œ: %s\n", date_str);

    // 2. íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë¡œì§
    if (file_exists(json_filename)) {
        printf("âœ… [í™•ì¸] ë°ì´í„° íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\n");
    } else {
        printf("ğŸš€ [í™•ì¸] ìƒˆë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.\n");
        char command[1024];
        sprintf(command, "curl -f -L -o %s %s", gz_filename, url);
        system(command);
        sprintf(command, "powershell -Command \"$in=[System.IO.File]::OpenRead('%s'); $out=[System.IO.File]::Create('%s'); $gz=[System.IO.Compression.GZipStream]::new($in,[System.IO.Compression.CompressionMode]::Decompress); $gz.CopyTo($out); $gz.Close(); $out.Close(); $in.Close()\"", gz_filename, json_filename);
        system(command);
        sprintf(command, "del %s", gz_filename);
        system(command);
    }

    // 3. ë°ì´í„° ì½ê¸° ë° ë©”ëª¨ë¦¬ ì €ì¥ (ì •ë ¬ì„ ìœ„í•´ í•„ìˆ˜)
    printf("[3ë‹¨ê³„] ë°ì´í„° ì½ê³  ì •ë ¬í•˜ëŠ” ì¤‘...\n");
    
    FILE *fp_in = fopen(json_filename, "r");
    if (fp_in == NULL) return 1;

    // êµ¬ì¡°ì²´ ë°°ì—´ ë™ì  í• ë‹¹
    Movie *movie_list = (Movie *)malloc(sizeof(Movie) * MAX_MOVIES);
    int movie_count = 0;
    char buffer[4096];
    char temp_title[1024];

    while (fgets(buffer, sizeof(buffer), fp_in) != NULL) {
        if (movie_count >= MAX_MOVIES) break; // ë©”ëª¨ë¦¬ ì´ˆê³¼ ë°©ì§€

        get_json_string(buffer, "original_title", temp_title);
        
        if (strlen(temp_title) > 0) {
            strcpy(movie_list[movie_count].title, temp_title);
            movie_list[movie_count].popularity = get_json_double(buffer, "popularity");
            movie_list[movie_count].id = (int)get_json_double(buffer, "id");
            
            // ì¸ê¸°ë„ê°€ 0ì´ê±°ë‚˜ ë„ˆë¬´ ë‚®ì€ ë°ì´í„°ëŠ” ê±°ë¥´ëŠ” ê²Œ ì¢‹ìŒ (ì„ íƒì‚¬í•­)
            if (movie_list[movie_count].popularity > 0.0) {
                movie_count++;
            }
        }
    }
    fclose(fp_in);

    // [í•µì‹¬] ì •ë ¬ ìˆ˜í–‰ (Quick Sort)
    qsort(movie_list, movie_count, sizeof(Movie), compare_movies);
    printf("--> ì´ %dê°œ ì˜í™” ì¤‘ ìƒìœ„ 100ê°œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.\n", movie_count);


    // 4. HTML ìƒì„±
    printf("[4ë‹¨ê³„] index.html ìƒì„± ì¤‘...\n");
    FILE *fp_out = fopen("index.html", "w");

    // HTML í—¤ë”
    fprintf(fp_out, "<!DOCTYPE html>\n<html lang='ko'>\n<head>\n");
    fprintf(fp_out, "<meta charset='euc-kr'>\n"); 
    fprintf(fp_out, "<meta name='viewport' content='width=device-width, initial-scale=1.0'>\n");
    fprintf(fp_out, "<title>MOVIE RANKING</title>\n");
    fprintf(fp_out, "<link href='https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap' rel='stylesheet'>\n");
    
    // CSS ìŠ¤íƒ€ì¼
    fprintf(fp_out, "<style>\n");
    fprintf(fp_out, "  body { background-color: #141414; color: white; font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }\n");
    fprintf(fp_out, "  h1 { color: #e50914; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }\n");
    fprintf(fp_out, "  .info-text { color: #aaa; margin-bottom: 30px; font-size: 0.9rem; }\n");
    fprintf(fp_out, "  .container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 100%%; max-width: 1200px; flex: 1; }\n");
    
    // ì¹´ë“œ ìŠ¤íƒ€ì¼
    fprintf(fp_out, "  .card { background-color: #222; border-radius: 5px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: transform 0.3s ease; position: relative; border-top: 3px solid transparent; height: 100%%; display: flex; flex-direction: column; cursor: pointer; }\n");
    fprintf(fp_out, "  .card:hover { transform: translateY(-7px); background-color: #2a2a2a; border-top: 3px solid #e50914; }\n");
    fprintf(fp_out, "  .card-header { height: 140px; background: linear-gradient(45deg, #000, #333); display: flex; align-items: center; justify-content: center; font-size: 40px; color: #444; flex-shrink: 0; }\n");
    fprintf(fp_out, "  .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }\n");
    fprintf(fp_out, "  .score-badge { position: absolute; top: 10px; right: 10px; background-color: rgba(0,0,0,0.7); border: 1px solid #555; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; color: #fff; }\n");
    fprintf(fp_out, "  .score-high { color: #46d369; border-color: #46d369; }\n");
    fprintf(fp_out, "  .score-mid { color: #e50914; border-color: #e50914; }\n");
    fprintf(fp_out, "  .score-low { color: #aaa; border-color: #aaa; }\n");
    fprintf(fp_out, "  .title { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; line-height: 1.4; }\n");
    fprintf(fp_out, "  .id-text { font-size: 0.8rem; color: #666; margin-top: 10px; }\n");

    // í˜ì´ì§€ë„¤ì´ì…˜
    fprintf(fp_out, "  .pagination { margin-top: 40px; display: flex; gap: 10px; align-items: center; margin-bottom: 40px; }\n");
    fprintf(fp_out, "  .page-btn { padding: 10px 20px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-family: 'Noto Sans KR'; transition: 0.3s; }\n");
    fprintf(fp_out, "  .page-btn:hover { background-color: #e50914; }\n");
    fprintf(fp_out, "  .page-btn:disabled { background-color: #222; color: #555; cursor: not-allowed; }\n");

    // ëª¨ë‹¬(íŒì—…) ìŠ¤íƒ€ì¼
    fprintf(fp_out, "  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%%; height: 100%%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }\n");
    fprintf(fp_out, "  .modal-box { background: #181818; width: 90%%; max-width: 600px; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.8); animation: fadeIn 0.3s ease; position: relative; }\n");
    fprintf(fp_out, "  .modal-header { padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: flex-start; }\n");
    fprintf(fp_out, "  .modal-title { font-size: 1.8rem; font-weight: bold; margin: 0; color: #fff; }\n");
    fprintf(fp_out, "  .close-btn { background: none; border: none; color: #aaa; font-size: 2rem; cursor: pointer; line-height: 1; }\n");
    fprintf(fp_out, "  .close-btn:hover { color: white; }\n");
    fprintf(fp_out, "  .modal-body { padding: 20px; }\n");
    fprintf(fp_out, "  .modal-desc { color: #ccc; line-height: 1.6; margin-bottom: 20px; }\n");
    fprintf(fp_out, "  .input-box { display: flex; gap: 10px; margin-bottom: 20px; }\n");
    fprintf(fp_out, "  .input-box input { flex: 1; padding: 12px; border-radius: 5px; border: none; outline: none; background-color: #333; color: white; }\n");
    fprintf(fp_out, "  .action-btn { padding: 10px 20px; background-color: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; text-align: center; }\n");
    fprintf(fp_out, "  .action-btn:hover { background-color: #b20710; }\n");
    fprintf(fp_out, "  .tmdb-link { background-color: #fff; color: #141414; margin-top: 10px; width: 100%%; box-sizing: border-box; }\n");
    fprintf(fp_out, "  .tmdb-link:hover { background-color: #ddd; }\n");
    fprintf(fp_out, "  .review-list { max-height: 200px; overflow-y: auto; }\n");
    fprintf(fp_out, "  .review-item { background-color: #2a2a2a; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid #e50914; font-size: 0.9rem; animation: slideIn 0.3s ease; }\n");
    fprintf(fp_out, "  @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }\n");
    fprintf(fp_out, "  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\n");
    fprintf(fp_out, "</style>\n</head>\n<body>\n");
    
    fprintf(fp_out, "<h1>TOP 100 MOVIES (%s)</h1>\n", date_str);
    fprintf(fp_out, "<div class='info-text'>DATA SOURCE: TMDB Daily Export (Sorted by Popularity)</div>\n");
    fprintf(fp_out, "<div class='container' id='movie-list'>\n");

    // HTML ì¶œë ¥ (ì •ë ¬ëœ ë°ì´í„° ì‚¬ìš©)
    char safe_title[2048];
    for (int i = 0; i < movie_count && i < 100; i++) {
        escape_quotes(safe_title, movie_list[i].title); 

        char *score_class = "score-low";
        if (movie_list[i].popularity >= 100.0) score_class = "score-high"; // ê¸°ì¤€ ìƒí–¥ (ì¸ê¸°ë„ ìˆœì´ë‹ˆê¹Œ)
        else if (movie_list[i].popularity >= 50.0) score_class = "score-mid";

        fprintf(fp_out, "  <div class='card movie-item' onclick='openModal(this)' \n");
        fprintf(fp_out, "       data-id='%d' data-title='%s' data-score='%.1f'>\n", movie_list[i].id, safe_title, movie_list[i].popularity);
        
        fprintf(fp_out, "    <div class='score-badge %s'>%.1f</div>\n", score_class, movie_list[i].popularity);
        fprintf(fp_out, "    <div class='card-header'>%d</div>\n", i+1); // ìˆœìœ„ í‘œì‹œ
        fprintf(fp_out, "    <div class='card-body'>\n");
        fprintf(fp_out, "      <div class='title'>%s</div>\n", movie_list[i].title);
        fprintf(fp_out, "      <div class='id-text'>ID: %d</div>\n", movie_list[i].id);
        fprintf(fp_out, "    </div>\n");
        fprintf(fp_out, "  </div>\n");
    }

    // ë©”ëª¨ë¦¬ í•´ì œ
    free(movie_list);

    fprintf(fp_out, "</div>\n");

    // í˜ì´ì§€ë„¤ì´ì…˜
    fprintf(fp_out, "<div class='pagination'>\n");
    fprintf(fp_out, "  <button id='prev-btn' class='page-btn' onclick='changePage(-1)'>ì´ì „</button>\n");
    fprintf(fp_out, "  <span id='page-info'></span>\n");
    fprintf(fp_out, "  <button id='next-btn' class='page-btn' onclick='changePage(1)'>ë‹¤ìŒ</button>\n");
    fprintf(fp_out, "</div>\n");

    // ëª¨ë‹¬ HTML
    fprintf(fp_out, "<div id='movieModal' class='modal-overlay' onclick='closeModal(event)'>\n");
    fprintf(fp_out, "  <div class='modal-box'>\n");
    fprintf(fp_out, "    <div class='modal-header'>\n");
    fprintf(fp_out, "      <div>\n");
    fprintf(fp_out, "        <h2 id='m-title' class='modal-title'>Movie Title</h2>\n");
    fprintf(fp_out, "        <span id='m-score' style='color:#46d369; font-weight:bold;'>Score: 0.0</span>\n");
    fprintf(fp_out, "      </div>\n");
    fprintf(fp_out, "      <button class='close-btn' onclick='closeModal(event)'>&times;</button>\n");
    fprintf(fp_out, "    </div>\n");
    fprintf(fp_out, "    <div class='modal-body'>\n");
    fprintf(fp_out, "      <p class='modal-desc'>ì´ ì˜í™”ì— ëŒ€í•œ ê°ìƒí‰ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>\n");
    fprintf(fp_out, "      <div class='input-box'>\n");
    fprintf(fp_out, "        <input type='text' id='reviewInput' placeholder='ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì„¸ìš”...'>\n");
    fprintf(fp_out, "        <button class='action-btn' onclick='addReview()'>ë“±ë¡</button>\n");
    fprintf(fp_out, "      </div>\n");
    fprintf(fp_out, "      <div id='reviewList' class='review-list'></div>\n");
    fprintf(fp_out, "      <a id='m-link' href='#' target='_blank' class='action-btn tmdb-link'>TMDB ìƒì„¸ ì •ë³´ ë³´ê¸°</a>\n");
    fprintf(fp_out, "    </div>\n");
    fprintf(fp_out, "  </div>\n");
    fprintf(fp_out, "</div>\n");

    // ìë°”ìŠ¤í¬ë¦½íŠ¸
    fprintf(fp_out, "<script>\n");
    fprintf(fp_out, "  const itemsPerPage = 12;\n");
    fprintf(fp_out, "  let currentPage = 1;\n");
    fprintf(fp_out, "  const items = document.querySelectorAll('.movie-item');\n");
    fprintf(fp_out, "  const totalPages = Math.ceil(items.length / itemsPerPage);\n");
    fprintf(fp_out, "  function showPage(page) {\n");
    fprintf(fp_out, "    if (page < 1) page = 1;\n");
    fprintf(fp_out, "    if (page > totalPages) page = totalPages;\n");
    fprintf(fp_out, "    currentPage = page;\n");
    fprintf(fp_out, "    const start = (page - 1) * itemsPerPage;\n");
    fprintf(fp_out, "    const end = start + itemsPerPage;\n");
    fprintf(fp_out, "    items.forEach((item, index) => {\n");
    fprintf(fp_out, "      item.style.display = (index >= start && index < end) ? 'flex' : 'none';\n");
    fprintf(fp_out, "    });\n");
    fprintf(fp_out, "    document.getElementById('page-info').innerText = `${currentPage} / ${totalPages}`;\n");
    fprintf(fp_out, "    document.getElementById('prev-btn').disabled = (currentPage === 1);\n");
    fprintf(fp_out, "    document.getElementById('next-btn').disabled = (currentPage === totalPages);\n");
    fprintf(fp_out, "  }\n");
    fprintf(fp_out, "  function changePage(dir) { showPage(currentPage + dir); }\n");
    fprintf(fp_out, "  showPage(1);\n");

    // ëª¨ë‹¬ ë¡œì§
    fprintf(fp_out, "  const modal = document.getElementById('movieModal');\n");
    fprintf(fp_out, "  const titleElem = document.getElementById('m-title');\n");
    fprintf(fp_out, "  const scoreElem = document.getElementById('m-score');\n");
    fprintf(fp_out, "  const linkElem = document.getElementById('m-link');\n");
    fprintf(fp_out, "  const reviewList = document.getElementById('reviewList');\n");

    fprintf(fp_out, "  function openModal(card) {\n");
    fprintf(fp_out, "    const title = card.getAttribute('data-title');\n");
    fprintf(fp_out, "    const id = card.getAttribute('data-id');\n");
    fprintf(fp_out, "    const score = card.getAttribute('data-score');\n");
    fprintf(fp_out, "    titleElem.innerText = title;\n");
    fprintf(fp_out, "    scoreElem.innerText = 'ì¸ê¸°ë„: ' + score;\n");
    fprintf(fp_out, "    linkElem.href = 'https://www.themoviedb.org/movie/' + id;\n");
    fprintf(fp_out, "    reviewList.innerHTML = '';\n");
    fprintf(fp_out, "    const guide = document.createElement('div'); guide.className='review-item'; guide.id='guide-msg'; guide.innerText='ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!'; reviewList.appendChild(guide);\n");
    fprintf(fp_out, "    modal.style.display = 'flex';\n");
    fprintf(fp_out, "  }\n");

    fprintf(fp_out, "  function closeModal(e) {\n");
    fprintf(fp_out, "    if (e.target === modal || e.target.classList.contains('close-btn')) {\n");
    fprintf(fp_out, "      modal.style.display = 'none';\n");
    fprintf(fp_out, "    }\n");
    fprintf(fp_out, "  }\n");

    fprintf(fp_out, "  function addReview() {\n");
    fprintf(fp_out, "    const input = document.getElementById('reviewInput');\n");
    fprintf(fp_out, "    if (input.value.trim() === '') return;\n");
    fprintf(fp_out, "    const guide = document.getElementById('guide-msg');\n");
    fprintf(fp_out, "    if (guide) guide.remove();\n");
    fprintf(fp_out, "    const div = document.createElement('div');\n");
    fprintf(fp_out, "    div.className = 'review-item';\n");
    fprintf(fp_out, "    div.innerText = input.value;\n");
    fprintf(fp_out, "    reviewList.prepend(div);\n");
    fprintf(fp_out, "    input.value = '';\n");
    fprintf(fp_out, "  }\n");
    fprintf(fp_out, "</script>\n");
    fprintf(fp_out, "</body>\n</html>");

    fclose(fp_out);

    printf("ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤...\n");
    system("start index.html");

    return 0;
}
